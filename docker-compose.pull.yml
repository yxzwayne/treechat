services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: treechat
      POSTGRES_USER: treechat
      POSTGRES_PASSWORD: treechat
    volumes:
      - treechat_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U treechat -d treechat"]
      interval: 2s
      timeout: 3s
      retries: 30

  app:
    # Publish an image (for example, to Docker Hub) and update this value.
    image: stellajager/treechat:latest
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://treechat:treechat@db:5432/treechat
      USE_MOCK: "${USE_MOCK:-1}"
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY:-}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      OPENROUTER_BASE_URL: "${OPENROUTER_BASE_URL:-}"
      OPENROUTER_SITE_URL: "${OPENROUTER_SITE_URL:-}"
      OPENROUTER_APP_NAME: "${OPENROUTER_APP_NAME:-}"
      SERVE_CLIENT: "1"
      PORT: "8787"
      DB_CONNECT_RETRIES: "60"
      DB_CONNECT_DELAY_MS: "1000"
    ports:
      - "${HOST_PORT:-8787}:8787"

volumes:
  treechat_db:
